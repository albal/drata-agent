name: Build Flatpak

on:
  push:
    branches: [main, master]
    paths:
      - 'cli/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'cli/**'
  workflow_dispatch:

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Flatpak and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Add Flathub repository
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install Flatpak SDK
        run: |
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Build Linux AMD64 binary
        working-directory: cli
        run: |
          make build-linux
          chmod +x build/drata-agent-linux-amd64

      - name: Create Flatpak manifest
        run: |
          mkdir -p flatpak-build
          
          # Create manifest for CLI-only application (no desktop/UI components)
          # Install osqueryi to /app/bin so it's in PATH for Flatpak sandboxed environment
          cat > flatpak-build/com.drata.Agent.yml << 'EOF'
          app-id: com.drata.Agent
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: drata-agent
          finish-args:
            - --share=network
            - --filesystem=home
          modules:
            - name: drata-agent
              buildsystem: simple
              build-commands:
                - install -Dm755 drata-agent-linux-amd64 /app/bin/drata-agent
                - install -Dm755 osqueryi /app/bin/osqueryi
              sources:
                - type: file
                  path: drata-agent-linux-amd64
                - type: file
                  path: osqueryi
          EOF

      - name: Copy binaries to flatpak build directory
        run: |
          cp cli/build/drata-agent-linux-amd64 flatpak-build/
          cp lib/linux/bin/osqueryi flatpak-build/

      - name: Build Flatpak
        working-directory: flatpak-build
        run: |
          flatpak-builder --force-clean --repo=repo builddir com.drata.Agent.yml
          
          # Create single-file bundle
          flatpak build-bundle repo drata-agent.flatpak com.drata.Agent

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: drata-agent-flatpak-amd64
          path: flatpak-build/drata-agent.flatpak
          retention-days: 30
