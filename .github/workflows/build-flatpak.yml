name: Build Flatpak

on:
  push:
    branches: [main, master]
    paths:
      - 'cli/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'cli/**'
  workflow_dispatch:

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Flatpak and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Add Flathub repository
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install Flatpak SDK
        run: |
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Build Linux AMD64 binary
        working-directory: cli
        run: |
          make build-linux
          chmod +x build/drata-agent-linux-amd64

      - name: Create Flatpak manifest
        run: |
          mkdir -p flatpak-build
          
          cat > flatpak-build/com.drata.Agent.yml << 'EOF'
          app-id: com.drata.Agent
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: drata-agent
          finish-args:
            - --share=network
            - --filesystem=home
            - --talk-name=org.freedesktop.secrets
          modules:
            - name: drata-agent
              buildsystem: simple
              build-commands:
                - install -Dm755 drata-agent-linux-amd64 /app/bin/drata-agent
              sources:
                - type: file
                  path: drata-agent-linux-amd64
          EOF

      - name: Copy binary to flatpak build directory
        run: |
          cp cli/build/drata-agent-linux-amd64 flatpak-build/

      - name: Create desktop entry
        run: |
          mkdir -p flatpak-build/share/applications
          cat > flatpak-build/share/applications/com.drata.Agent.desktop << 'EOF'
          [Desktop Entry]
          Name=Drata Agent
          Comment=SOC 2 compliance monitoring agent
          Exec=drata-agent
          Icon=com.drata.Agent
          Terminal=true
          Type=Application
          Categories=Utility;
          EOF

      - name: Create AppStream metadata
        run: |
          mkdir -p flatpak-build/share/metainfo
          cat > flatpak-build/share/metainfo/com.drata.Agent.metainfo.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="console-application">
            <id>com.drata.Agent</id>
            <name>Drata Agent</name>
            <summary>SOC 2 compliance monitoring agent</summary>
            <metadata_license>CC0-1.0</metadata_license>
            <project_license>Apache-2.0</project_license>
            <description>
              <p>
                The Drata Agent CLI is a command-line version of the Drata Agent
                that monitors your system's security configuration for SOC 2 compliance.
              </p>
              <p>
                It collects read-only information about your system's security settings
                including screensaver locking, password manager, antivirus software,
                and automatic updates.
              </p>
            </description>
            <url type="homepage">https://drata.com</url>
            <url type="help">https://help.drata.com</url>
            <provides>
              <binary>drata-agent</binary>
            </provides>
            <releases>
              <release version="3.9.0" date="2025-01-01">
                <description>
                  <p>Initial CLI release</p>
                </description>
              </release>
            </releases>
            <content_rating type="oars-1.1" />
          </component>
          EOF

      - name: Update manifest with additional files
        run: |
          cat > flatpak-build/com.drata.Agent.yml << 'EOF'
          app-id: com.drata.Agent
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: drata-agent
          finish-args:
            - --share=network
            - --filesystem=home
            - --talk-name=org.freedesktop.secrets
          modules:
            - name: drata-agent
              buildsystem: simple
              build-commands:
                - install -Dm755 drata-agent-linux-amd64 /app/bin/drata-agent
                - install -Dm644 share/applications/com.drata.Agent.desktop /app/share/applications/com.drata.Agent.desktop
                - install -Dm644 share/metainfo/com.drata.Agent.metainfo.xml /app/share/metainfo/com.drata.Agent.metainfo.xml
              sources:
                - type: file
                  path: drata-agent-linux-amd64
                - type: dir
                  path: share
          EOF

      - name: Build Flatpak
        working-directory: flatpak-build
        run: |
          flatpak-builder --force-clean --repo=repo builddir com.drata.Agent.yml
          
          # Create single-file bundle
          flatpak build-bundle repo drata-agent.flatpak com.drata.Agent

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: drata-agent-flatpak-amd64
          path: flatpak-build/drata-agent.flatpak
          retention-days: 30
