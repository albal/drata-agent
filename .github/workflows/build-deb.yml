name: Build DEB Package

on:
  push:
    branches: [main, master]
    paths:
      - 'cli/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'cli/**'
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev

      - name: Build Linux AMD64 binary
        working-directory: cli
        run: |
          make build-linux
          chmod +x build/drata-agent-linux-amd64

      - name: Create DEB package structure
        run: |
          VERSION="3.9.0"
          PKG_NAME="drata-agent"
          PKG_DIR="${PKG_NAME}_${VERSION}_amd64"
          
          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin
          mkdir -p ${PKG_DIR}/usr/share/doc/${PKG_NAME}
          mkdir -p ${PKG_DIR}/lib/systemd/system
          mkdir -p ${PKG_DIR}/usr/lib/drata-agent/bin
          
          # Copy binary
          cp cli/build/drata-agent-linux-amd64 ${PKG_DIR}/usr/bin/drata-agent
          
          # Copy osquery binary
          cp lib/linux/bin/osqueryi ${PKG_DIR}/usr/lib/drata-agent/bin/osqueryi
          chmod +x ${PKG_DIR}/usr/lib/drata-agent/bin/osqueryi
          
          # Create control file
          cat > ${PKG_DIR}/DEBIAN/control << EOF
          Package: ${PKG_NAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Drata Inc. <support@drata.com>
          Description: Drata Agent CLI
           The Drata Agent CLI is a command-line version of the Drata Agent
           that monitors your system's security configuration for SOC 2 compliance.
           It collects read-only information about your system's security settings.
          Homepage: https://drata.com
          EOF
          
          # Create copyright file
          cat > ${PKG_DIR}/usr/share/doc/${PKG_NAME}/copyright << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: drata-agent
          Source: https://github.com/drata/drata-agent
          
          Files: *
          Copyright: 2025 Drata Inc.
          License: Apache-2.0
          EOF
          
          # Create systemd service file
          cat > ${PKG_DIR}/lib/systemd/system/drata-agent.service << EOF
          [Unit]
          Description=Drata Agent
          After=network.target
          
          [Service]
          Type=simple
          ExecStart=/usr/bin/drata-agent daemon
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Create postinst script
          cat > ${PKG_DIR}/DEBIAN/postinst << EOF
          #!/bin/bash
          systemctl daemon-reload
          echo "Drata Agent installed successfully."
          echo "To register: drata-agent register YOUR_TOKEN --region NA"
          echo "To start daemon: systemctl enable --now drata-agent"
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/postinst
          
          # Create prerm script
          cat > ${PKG_DIR}/DEBIAN/prerm << EOF
          #!/bin/bash
          systemctl stop drata-agent 2>/dev/null || true
          systemctl disable drata-agent 2>/dev/null || true
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/prerm

      - name: Build DEB package
        run: |
          VERSION="3.9.0"
          PKG_NAME="drata-agent"
          PKG_DIR="${PKG_NAME}_${VERSION}_amd64"
          
          dpkg-deb --build ${PKG_DIR}
          
          # Verify package
          dpkg-deb --info ${PKG_DIR}.deb
          dpkg-deb --contents ${PKG_DIR}.deb

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: drata-agent-deb-amd64
          path: "*.deb"
          retention-days: 30
