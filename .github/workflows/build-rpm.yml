name: Build and Release Linux CLI RPM

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 3.9.0)'
        required: false
        default: ''

permissions:
  contents: write
  packages: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build CLI
        run: yarn build:cli

      - name: Get version
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install RPM build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm rpmlint

      - name: Create RPM build structure
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # Create source tarball
          mkdir -p drata-agent-cli-${{ steps.get_version.outputs.version }}
          cp dist/cli.js drata-agent-cli-${{ steps.get_version.outputs.version }}/
          cp lib/linux/bin/osqueryi drata-agent-cli-${{ steps.get_version.outputs.version }}/
          cp README.md drata-agent-cli-${{ steps.get_version.outputs.version }}/
          cp LICENSE drata-agent-cli-${{ steps.get_version.outputs.version }}/
          
          tar -czvf ~/rpmbuild/SOURCES/drata-agent-cli-${{ steps.get_version.outputs.version }}.tar.gz \
            drata-agent-cli-${{ steps.get_version.outputs.version }}

      - name: Create RPM spec file
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          cat > ~/rpmbuild/SPECS/drata-agent-cli.spec << EOF
          Name:           drata-agent-cli
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        Drata Agent CLI for Linux
          License:        Apache-2.0
          URL:            https://github.com/${REPO}
          Source0:        %{name}-%{version}.tar.gz
          
          BuildArch:      x86_64
          Requires:       nodejs >= 22
          
          %description
          The Drata Agent CLI is a lightweight command-line application that reports
          read-only data about your machine's state for SOC 2 compliance tracking.
          It collects information about security configurations such as screensaver
          locking, password managers, antivirus software, and automatic updates.
          
          %prep
          %setup -q
          
          %install
          mkdir -p %{buildroot}/opt/drata-agent-cli
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/opt/drata-agent-cli/lib/linux/bin
          
          install -m 755 cli.js %{buildroot}/opt/drata-agent-cli/
          install -m 755 osqueryi %{buildroot}/opt/drata-agent-cli/lib/linux/bin/
          install -m 644 README.md %{buildroot}/opt/drata-agent-cli/
          install -m 644 LICENSE %{buildroot}/opt/drata-agent-cli/
          
          # Create wrapper script
          cat > %{buildroot}/usr/bin/drata-agent << 'WRAPPER'
          #!/bin/bash
          cd /opt/drata-agent-cli
          exec node /opt/drata-agent-cli/cli.js "\$@"
          WRAPPER
          chmod 755 %{buildroot}/usr/bin/drata-agent
          
          %files
          /opt/drata-agent-cli
          /usr/bin/drata-agent
          
          %changelog
          * $(date "+%a %b %d %Y") Drata Inc <drata@drata.com> - ${VERSION}-1
          - Initial RPM release of Drata Agent CLI
          EOF

      - name: Build RPM
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/drata-agent-cli.spec

      - name: Find and rename RPM
        id: find_rpm
        run: |
          RPM_FILE=$(find ~/rpmbuild/RPMS -name "*.rpm" | head -1)
          RPM_NAME=$(basename "$RPM_FILE")
          cp "$RPM_FILE" ./"$RPM_NAME"
          echo "rpm_file=$RPM_NAME" >> $GITHUB_OUTPUT
          echo "rpm_path=./$RPM_NAME" >> $GITHUB_OUTPUT

      - name: Lint RPM
        run: rpmlint ${{ steps.find_rpm.outputs.rpm_path }} || true

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: drata-agent-cli-rpm
          path: ${{ steps.find_rpm.outputs.rpm_path }}

      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_rpm.outputs.rpm_path }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
