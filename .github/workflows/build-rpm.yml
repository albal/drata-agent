name: Build RPM Package

on:
  push:
    branches: [main, master]
    paths:
      - 'cli/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'cli/**'
  workflow_dispatch:

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y golang rpm-build rpmdevtools systemd-rpm-macros

      - name: Set up RPM build environment
        run: |
          rpmdev-setuptree

      - name: Build Linux AMD64 binary
        working-directory: cli
        run: |
          go mod download
          go mod tidy
          GOOS=linux GOARCH=amd64 go build -ldflags "-s -w -X main.version=3.9.0-cli" -o build/drata-agent-linux-amd64 .
          chmod +x build/drata-agent-linux-amd64

      - name: Create RPM spec file
        run: |
          CHANGELOG_DATE=$(date "+%a %b %d %Y")
          SPEC_FILE=~/rpmbuild/SPECS/drata-agent.spec
          
          # Write spec file line by line to avoid heredoc whitespace issues
          echo "Name:           drata-agent" > $SPEC_FILE
          echo "Version:        3.9.0" >> $SPEC_FILE
          echo "Release:        1%{?dist}" >> $SPEC_FILE
          echo "Summary:        Drata Agent CLI for SOC 2 compliance monitoring" >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "License:        Apache-2.0" >> $SPEC_FILE
          echo "URL:            https://drata.com" >> $SPEC_FILE
          echo "Source0:        drata-agent-linux-amd64" >> $SPEC_FILE
          echo "Source1:        drata-agent.service" >> $SPEC_FILE
          echo "Source2:        osqueryi" >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "BuildArch:      x86_64" >> $SPEC_FILE
          echo "Requires:       systemd" >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "%description" >> $SPEC_FILE
          echo "The Drata Agent CLI is a command-line version of the Drata Agent" >> $SPEC_FILE
          echo "that monitors your system's security configuration for SOC 2 compliance." >> $SPEC_FILE
          echo "It collects read-only information about your system's security settings" >> $SPEC_FILE
          echo "including screensaver locking, password manager, antivirus software," >> $SPEC_FILE
          echo "and automatic updates." >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "%install" >> $SPEC_FILE
          echo "mkdir -p %{buildroot}%{_bindir}" >> $SPEC_FILE
          echo "mkdir -p %{buildroot}%{_unitdir}" >> $SPEC_FILE
          echo "mkdir -p %{buildroot}%{_libdir}/drata-agent/bin" >> $SPEC_FILE
          echo "install -m 755 %{SOURCE0} %{buildroot}%{_bindir}/drata-agent" >> $SPEC_FILE
          echo "install -m 644 %{SOURCE1} %{buildroot}%{_unitdir}/drata-agent.service" >> $SPEC_FILE
          echo "install -m 755 %{SOURCE2} %{buildroot}%{_libdir}/drata-agent/bin/osqueryi" >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "%files" >> $SPEC_FILE
          echo "%{_bindir}/drata-agent" >> $SPEC_FILE
          echo "%{_unitdir}/drata-agent.service" >> $SPEC_FILE
          echo "%{_libdir}/drata-agent/bin/osqueryi" >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "%post" >> $SPEC_FILE
          echo "%systemd_post drata-agent.service" >> $SPEC_FILE
          echo 'echo "Drata Agent installed successfully."' >> $SPEC_FILE
          echo 'echo "To register: drata-agent register YOUR_TOKEN --region NA"' >> $SPEC_FILE
          echo 'echo "To start daemon: systemctl enable --now drata-agent"' >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "%preun" >> $SPEC_FILE
          echo "%systemd_preun drata-agent.service" >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "%postun" >> $SPEC_FILE
          echo "%systemd_postun_with_restart drata-agent.service" >> $SPEC_FILE
          echo "" >> $SPEC_FILE
          echo "%changelog" >> $SPEC_FILE
          echo "* ${CHANGELOG_DATE} Drata Inc <support@drata.com> - 3.9.0-1" >> $SPEC_FILE
          echo "- Initial RPM release of Drata Agent CLI" >> $SPEC_FILE

      - name: Create systemd service file for RPM
        run: |
          SERVICE_FILE=~/rpmbuild/SOURCES/drata-agent.service
          echo "[Unit]" > $SERVICE_FILE
          echo "Description=Drata Agent" >> $SERVICE_FILE
          echo "After=network.target" >> $SERVICE_FILE
          echo "" >> $SERVICE_FILE
          echo "[Service]" >> $SERVICE_FILE
          echo "Type=simple" >> $SERVICE_FILE
          echo "ExecStart=/usr/bin/drata-agent daemon" >> $SERVICE_FILE
          echo "Restart=always" >> $SERVICE_FILE
          echo "RestartSec=10" >> $SERVICE_FILE
          echo "" >> $SERVICE_FILE
          echo "[Install]" >> $SERVICE_FILE
          echo "WantedBy=multi-user.target" >> $SERVICE_FILE

      - name: Copy binaries to SOURCES
        run: |
          cp cli/build/drata-agent-linux-amd64 ~/rpmbuild/SOURCES/
          cp lib/linux/bin/osqueryi ~/rpmbuild/SOURCES/

      - name: Debug - Show spec file content
        run: |
          echo "=== RPM Spec File Content ==="
          cat ~/rpmbuild/SPECS/drata-agent.spec
          echo "=== End Spec File ==="

      - name: Build RPM package
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/drata-agent.spec
          
          # List built RPMs
          ls -la ~/rpmbuild/RPMS/x86_64/

      - name: Copy RPM to workspace
        run: |
          cp ~/rpmbuild/RPMS/x86_64/*.rpm .

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: drata-agent-rpm-amd64
          path: "*.rpm"
          retention-days: 30
