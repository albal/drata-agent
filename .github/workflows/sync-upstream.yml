name: Sync Upstream

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch remotes
        run: |
          git fetch origin main
          git fetch upstream main

      - name: Detect upstream changes
        id: detect
        run: |
          if git diff --quiet origin/main upstream/main; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Backup .github directory
        if: steps.detect.outputs.changed == 'true'
        run: |
          if [ -d .github ]; then
            mkdir -p /tmp/github-backup
            rsync -a .github/ /tmp/github-backup/
          fi

      - name: Sync main from upstream
        if: steps.detect.outputs.changed == 'true'
        run: |
          git checkout main
          git reset --hard upstream/main

      - name: Restore .github directory
        if: steps.detect.outputs.changed == 'true'
        run: |
          if [ -d /tmp/github-backup ]; then
            rm -rf .github
            mkdir -p .github
            rsync -a /tmp/github-backup/ .github/
          fi

      - name: Stage changes
        if: steps.detect.outputs.changed == 'true'
        run: git add -A

      - name: Commit sync
        if: steps.detect.outputs.changed == 'true'
        run: |
          git commit -m "chore: sync from upstream" || echo "No changes to commit"

      - name: Push to origin
        if: steps.detect.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" main
